{% extends "base.html" %}

{% block title %}Users - CopyArena Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-users"></i>
        User Management
    </h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <span class="badge badge-primary">{{ pagination.total }} Total Users</span>
        <span id="onlineCount" class="badge badge-success">0 Online</span>
    </div>
</div>

<!-- Users Table -->
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Email</th>
                <th>Subscription</th>
                <th>Trading Stats</th>
                <th>Followers</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user_data in users %}
            <tr {% if user_data.user.is_master_trader %}style="background: linear-gradient(to right, rgba(255, 215, 0, 0.1), rgba(255, 237, 74, 0.05)); border-left: 3px solid #ffd700;"{% endif %}>
                <td>{{ user_data.user.id }}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        {% if user_data.user.is_master_trader %}
                            <i class="fas fa-crown" style="color: #ffd700; margin-right: 0.25rem;"></i>
                        {% endif %}
                        <i class="fas fa-user-circle" style="color: hsl(var(--primary));"></i>
                        <div>
                            <strong {% if user_data.user.is_master_trader %}style="color: #b45309; font-weight: 800;"{% endif %}>
                                {{ user_data.user.username }}
                                {% if user_data.user.is_master_trader %}
                                    <small style="color: #d97706; font-weight: 600; margin-left: 0.25rem;">(Master)</small>
                                {% endif %}
                            </strong>
                            <span id="online-badge-{{ user_data.user.id }}" class="badge badge-success" style="display: none; margin-left: 0.5rem;">
                                Online
                            </span>
                        </div>
                    </div>
                </td>
                <td>{{ user_data.user.email }}</td>
                <td>
                    {% if user_data.user.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% if user_data.user.is_verified %}
                            <span class="badge badge-secondary" style="margin-left: 0.5rem;">Verified</span>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-danger">Inactive</span>
                    {% endif %}
                    
                    <!-- Master Trader Badge -->
                    {% if user_data.user.is_master_trader %}
                        <div style="margin-top: 0.25rem;">
                            <span class="badge" style="background: linear-gradient(45deg, #ffd700, #ffed4a); color: #92400e; font-weight: 700; border: 1px solid #d97706;">
                                <i class="fas fa-crown" style="margin-right: 0.25rem; color: #b45309;"></i>
                                Master Trader
                            </span>
                        </div>
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-primary">{{ user_data.trade_count }}</span>
                    {% if user_data.open_trades > 0 %}
                        <span class="badge badge-warning" style="margin-left: 0.5rem;">{{ user_data.open_trades }} Open</span>
                    {% endif %}
                    <div style="margin-top: 0.25rem;">
                        {% if user_data.total_profit >= 0 %}
                            <span style="color: #10b981; font-weight: 600; font-size: 0.875rem;">${{ "%.2f"|format(user_data.total_profit) }}</span>
                        {% else %}
                            <span style="color: #ef4444; font-weight: 600; font-size: 0.875rem;">-${{ "%.2f"|format(-user_data.total_profit) }}</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <!-- Followers/Investors Data -->
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        {% if user_data.follower_count > 0 %}
                            <div>
                                <span class="badge badge-success">{{ user_data.follower_count }} Investors</span>
                                <i class="fas fa-users" style="margin-left: 0.25rem; color: #10b981;"></i>
                            </div>
                        {% else %}
                            <span class="badge badge-secondary">0 Investors</span>
                        {% endif %}
                        
                        {% if user_data.following_count > 0 %}
                            <div>
                                <span class="badge badge-info" style="font-size: 0.75rem;">Following {{ user_data.following_count }}</span>
                                <i class="fas fa-user-follow" style="margin-left: 0.25rem; color: #3b82f6;"></i>
                            </div>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <small style="color: hsl(var(--muted-foreground));">
                        {{ user_data.user.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </td>
                <td>
                    {% if user_data.user.is_active %}
                        <button class="btn btn-warning btn-sm user-toggle-btn" data-user-id="{{ user_data.user.id }}" data-action="suspend">
                            <i class="fas fa-ban" style="margin-right: 0.25rem;"></i>
                            Suspend
                        </button>
                    {% else %}
                        <button class="btn btn-success btn-sm user-toggle-btn" data-user-id="{{ user_data.user.id }}" data-action="activate">
                            <i class="fas fa-check" style="margin-right: 0.25rem;"></i>
                            Activate
                        </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if pagination.pages > 1 %}
<!-- Pagination -->
<div style="display: flex; justify-content: center; margin-top: 2rem;">
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        {% if pagination.page > 1 %}
            <a href="?page={{ pagination.page - 1 }}" class="btn btn-outline btn-sm">
                <i class="fas fa-chevron-left"></i>
                Previous
            </a>
        {% endif %}
        
        {% for page in range(1, pagination.pages + 1) %}
            {% if page == pagination.page %}
                <span class="btn btn-primary btn-sm">{{ page }}</span>
            {% elif page <= 3 or page >= pagination.pages - 2 or (page >= pagination.page - 1 and page <= pagination.page + 1) %}
                <a href="?page={{ page }}" class="btn btn-outline btn-sm">{{ page }}</a>
            {% elif page == 4 or page == pagination.pages - 3 %}
                <span class="btn btn-outline btn-sm" style="cursor: default;">...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.page < pagination.pages %}
            <a href="?page={{ pagination.page + 1 }}" class="btn btn-outline btn-sm">
                Next
                <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
// Real-time online status updates
let onlineUsers = new Set();

async function updateOnlineStatus() {
    try {
        const response = await fetch('/api/online-status');
        if (response.ok) {
            const data = await response.json();
            const newOnlineUsers = new Set(data.online_users);
            
            // Update online count
            document.getElementById('onlineCount').textContent = data.online_users.length + ' Online';
            
            // Update each user's online badge
            document.querySelectorAll('[id^="online-badge-"]').forEach(badge => {
                const userId = parseInt(badge.id.replace('online-badge-', ''));
                
                if (newOnlineUsers.has(userId)) {
                    // User is online
                    badge.className = 'badge badge-success';
                    badge.textContent = 'Online';
                    badge.style.display = 'inline';
                    badge.style.marginLeft = '0.5rem';
                    
                    // Add pulse effect if newly online
                    if (!onlineUsers.has(userId)) {
                        badge.style.animation = 'pulse 1s ease-in-out';
                        setTimeout(function() { badge.style.animation = ''; }, 1000);
                    }
                } else {
                    // User is offline
                    badge.style.display = 'none';
                }
            });
            
            onlineUsers = newOnlineUsers;
        }
    } catch (error) {
        console.error('Failed to update online status:', error);
    }
}

// Toggle user status (activate/suspend)
async function toggleUserStatus(userId, active) {
    try {
        const response = await fetch('/api/toggle-user/' + userId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ active: active })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Show success message
                showToast('Success', data.message, 'success');
                // Refresh the page to update the UI
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Error', data.error || 'Failed to update user', 'error');
            }
        } else {
            showToast('Error', 'Failed to communicate with server', 'error');
        }
    } catch (error) {
        console.error('Error toggling user status:', error);
        showToast('Error', 'Network error occurred', 'error');
    }
}

// Simple toast notification function
function showToast(title, message, type) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-' + (type === 'success' ? 'success' : 'danger') + ' border-0';
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.setAttribute('role', 'alert');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(function() {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Update online status every 3 seconds
updateOnlineStatus(); // Initial update
setInterval(updateOnlineStatus, 3000);

// Add event listeners for user toggle buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.user-toggle-btn').forEach(button => {
        button.addEventListener('click', function() {
            const userId = parseInt(this.getAttribute('data-user-id'));
            const action = this.getAttribute('data-action');
            const active = action === 'activate';
            
            toggleUserStatus(userId, active);
        });
    });
});
</script>
{% endblock %} 